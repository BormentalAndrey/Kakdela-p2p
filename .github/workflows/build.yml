name: Kakdela-p2p — Фаза 1: База (полностью рабочая автосборка)

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout репозитория
        uses: actions/checkout@v4

      - name: Установка Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Установка Android SDK
        uses: android-actions/setup-android@v3

      # Gradle 8.9 — совместимый с AGP 8.5.2
      - name: Установка Gradle Wrapper 8.9
        run: |
          mkdir -p gradle/wrapper
          curl -L https://raw.githubusercontent.com/gradle/gradle/v8.9.0/gradlew --output gradlew
          curl -L https://raw.githubusercontent.com/gradle/gradle/v8.9.0/gradlew.bat --output gradlew.bat
          curl -L https://raw.githubusercontent.com/gradle/gradle/v8.9.0/gradle/wrapper/gradle-wrapper.jar --output gradle/wrapper/gradle-wrapper.jar

          cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.9-all.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
          chmod +x gradlew

      - name: Создание local.properties и gradle.properties
        run: |
          echo "sdk.dir=$ANDROID_HOME" > local.properties
          cat > gradle.properties << 'EOF'
          android.useAndroidX=true
          android.enableJetifier=true
          org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8
          org.gradle.parallel=true
          org.gradle.caching=true
          EOF

      # Создание проекта Фаза 1: UI (список чатов, экран чата), Room (Message, Chat, DAO, Database), Repository, ViewModel, сохранение/загрузка сообщений
      - name: Создание проекта (Фаза 1 — База)
        run: |
          rm -rf app build.gradle.kts settings.gradle.kts
          mkdir -p app/src/main/java/com/kakdela/p2p/data
          mkdir -p app/src/main/java/com/kakdela/p2p/ui
          mkdir -p app/src/main/java/com/kakdela/p2p/viewmodel

          # settings.gradle.kts
          cat > settings.gradle.kts << 'EOF'
          pluginManagement {
              repositories {
                  gradlePluginPortal()
                  google()
                  mavenCentral()
              }
          }
          dependencyResolutionManagement {
              repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
              repositories {
                  google()
                  mavenCentral()
              }
          }
          rootProject.name = "Kakdela-p2p"
          include(":app")
          EOF

          # root build.gradle.kts
          cat > build.gradle.kts << 'EOF'
          plugins {
              id("com.android.application") version "8.5.2" apply false
              id("org.jetbrains.kotlin.android") version "1.9.25" apply false
          }
          EOF

          # app/build.gradle.kts — с Room и Compose
          cat > app/build.gradle.kts << 'EOF'
          plugins {
              id("com.android.application")
              id("org.jetbrains.kotlin.android")
          }

          android {
              namespace = "com.kakdela.p2p"
              compileSdk = 35

              defaultConfig {
                  applicationId = "com.kakdela.p2p"
                  minSdk = 21
                  targetSdk = 35
                  versionCode = 1
                  versionName = "1.0"
              }

              buildFeatures { compose = true }
              composeOptions { kotlinCompilerExtensionVersion = "1.5.15" }

              compileOptions {
                  sourceCompatibility = JavaVersion.VERSION_17
                  targetCompatibility = JavaVersion.VERSION_17
              }
              kotlinOptions { jvmTarget = "17" }
          }

          dependencies {
              implementation("androidx.core:core-ktx:1.13.1")
              implementation("androidx.activity:activity-compose:1.9.0")
              implementation(platform("androidx.compose:compose-bom:2024.10.00"))
              implementation("androidx.compose.ui:ui")
              implementation("androidx.compose.ui:ui-tooling-preview")
              implementation("androidx.compose.material3:material3")
              implementation("androidx.room:room-runtime:2.6.1")
              implementation("androidx.room:room-ktx:2.6.1")
              annotationProcessor("androidx.room:room-compiler:2.6.1")
              implementation("androidx.lifecycle:lifecycle-viewmodel-ktx:2.8.6")
              implementation("androidx.navigation:navigation-compose:2.8.1")
              debugImplementation("androidx.compose.ui:ui-tooling")
          }
          EOF

          # AndroidManifest.xml
          cat > app/src/main/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.kakdela.p2p">

              <application
                  android:label="Как дела P2P"
                  android:theme="@style/Theme.Material3.Light.NoActionBar">

                  <activity
                      android:name=".MainActivity"
                      android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

          # MainActivity.kt — с навигацией
          cat > app/src/main/java/com/kakdela/p2p/MainActivity.kt << 'EOF'
          package com.kakdela.p2p

          import android.os.Bundle
          import androidx.activity.ComponentActivity
          import androidx.activity.compose.setContent
          import androidx.compose.foundation.layout.fillMaxSize
          import androidx.compose.material3.MaterialTheme
          import androidx.compose.material3.Surface
          import androidx.compose.ui.Modifier
          import androidx.navigation.compose.NavHost
          import androidx.navigation.compose.composable
          import androidx.navigation.compose.rememberNavController
          import com.kakdela.p2p.ui.ChatListScreen
          import com.kakdela.p2p.ui.ChatScreen
          import com.kakdela.p2p.viewmodel.ChatViewModel
          import androidx.activity.viewModels

          class MainActivity : ComponentActivity() {
              private val viewModel: ChatViewModel by viewModels()

              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContent {
                      MaterialTheme {
                          Surface(modifier = Modifier.fillMaxSize()) {
                              val navController = rememberNavController()
                              NavHost(navController = navController, startDestination = "chatList") {
                                  composable("chatList") {
                                      ChatListScreen(viewModel, navController)
                                  }
                                  composable("chat/{chatId}") { backStackEntry ->
                                      val chatId = backStackEntry.arguments?.getString("chatId")?.toInt() ?: 0
                                      ChatScreen(viewModel, chatId, navController)
                                  }
                              }
                          }
                      }
                  }
              }
          }
          EOF

          # Message.kt (сущность)
          cat > app/src/main/java/com/kakdela/p2p/data/Message.kt << 'EOF'
          package com.kakdela.p2p.data

          import androidx.room.Entity
          import androidx.room.PrimaryKey

          @Entity(tableName = "messages")
          data class Message(
              @PrimaryKey(autoGenerate = true) val id: Int = 0,
              val chatId: Int,
              val text: String,
              val timestamp: Long = System.currentTimeMillis(),
              val isSentByMe: Boolean
          )
          EOF

          # Chat.kt (сущность)
          cat > app/src/main/java/com/kakdela/p2p/data/Chat.kt << 'EOF'
          package com.kakdela.p2p.data

          import androidx.room.Entity
          import androidx.room.PrimaryKey

          @Entity(tableName = "chats")
          data class Chat(
              @PrimaryKey(autoGenerate = true) val id: Int = 0,
              val name: String,
              val lastMessage: String = "",
              val lastTimestamp: Long = 0
          )
          EOF

          # ChatDao.kt
          cat > app/src/main/java/com/kakdela/p2p/data/ChatDao.kt << 'EOF'
          package com.kakdela.p2p.data

          import androidx.room.Dao
          import androidx.room.Insert
          import androidx.room.Query

          @Dao
          interface ChatDao {
              @Query("SELECT * FROM chats ORDER BY lastTimestamp DESC")
              fun getAllChats(): List<Chat>

              @Insert
              fun insertChat(chat: Chat)

              @Query("SELECT * FROM messages WHERE chatId = :chatId ORDER BY timestamp ASC")
              fun getMessagesForChat(chatId: Int): List<Message>

              @Insert
              fun insertMessage(message: Message)

              @Query("UPDATE chats SET lastMessage = :lastMessage, lastTimestamp = :lastTimestamp WHERE id = :chatId")
              fun updateChatLastMessage(chatId: Int, lastMessage: String, lastTimestamp: Long)
          }
          EOF

          # AppDatabase.kt
          cat > app/src/main/java/com/kakdela/p2p/data/AppDatabase.kt << 'EOF'
          package com.kakdela.p2p.data

          import androidx.room.Database
          import androidx.room.RoomDatabase

          @Database(entities = [Chat::class, Message::class], version = 1, exportSchema = false)
          abstract class AppDatabase : RoomDatabase() {
              abstract fun chatDao(): ChatDao
          }
          EOF

          # ChatRepository.kt
          cat > app/src/main/java/com/kakdela/p2p/data/ChatRepository.kt << 'EOF'
          package com.kakdela.p2p.data

          import android.content.Context
          import androidx.room.Room

          class ChatRepository(context: Context) {
              private val db = Room.databaseBuilder(
                  context.applicationContext,
                  AppDatabase::class.java,
                  "kakdela_db"
              ).build()
              private val dao = db.chatDao()

              fun getAllChats(): List<Chat> = dao.getAllChats()

              fun insertChat(chat: Chat) = dao.insertChat(chat)

              fun getMessagesForChat(chatId: Int): List<Message> = dao.getMessagesForChat(chatId)

              fun insertMessage(message: Message) = dao.insertMessage(message)

              fun updateChatLastMessage(chatId: Int, lastMessage: String, lastTimestamp: Long) = dao.updateChatLastMessage(chatId, lastMessage, lastTimestamp)
          }
          EOF

          # ChatViewModel.kt
          cat > app/src/main/java/com/kakdela/p2p/viewmodel/ChatViewModel.kt << 'EOF'
          package com.kakdela.p2p.viewmodel

          import android.app.Application
          import androidx.lifecycle.AndroidViewModel
          import androidx.lifecycle.LiveData
          import androidx.lifecycle.MutableLiveData
          import androidx.lifecycle.viewModelScope
          import com.kakdela.p2p.data.Chat
          import com.kakdela.p2p.data.ChatRepository
          import com.kakdela.p2p.data.Message
          import kotlinx.coroutines.launch

          class ChatViewModel(application: Application) : AndroidViewModel(application) {
              private val repository = ChatRepository(application)

              private val _chats = MutableLiveData<List<Chat>>()
              val chats: LiveData<List<Chat>> = _chats

              private val _messages = MutableLiveData<List<Message>>()
              val messages: LiveData<List<Message>> = _messages

              init {
                  loadChats()
              }

              private fun loadChats() {
                  viewModelScope.launch {
                      _chats.value = repository.getAllChats()
                  }
              }

              fun loadMessages(chatId: Int) {
                  viewModelScope.launch {
                      _messages.value = repository.getMessagesForChat(chatId)
                  }
              }

              fun sendMessage(chatId: Int, text: String, isSentByMe: Boolean) {
                  viewModelScope.launch {
                      val message = Message(chatId = chatId, text = text, isSentByMe = isSentByMe)
                      repository.insertMessage(message)
                      repository.updateChatLastMessage(chatId, text, message.timestamp)
                      loadMessages(chatId)
                      loadChats()
                  }
              }

              fun createChat(name: String) {
                  viewModelScope.launch {
                      val chat = Chat(name = name)
                      repository.insertChat(chat)
                      loadChats()
                  }
              }
          }
          EOF

          # ChatListScreen.kt
          cat > app/src/main/java/com/kakdela/p2p/ui/ChatListScreen.kt << 'EOF'
          package com.kakdela.p2p.ui

          import androidx.compose.foundation.lazy.LazyColumn
          import androidx.compose.foundation.lazy.items
          import androidx.compose.material3.*
          import androidx.compose.runtime.*
          import androidx.compose.ui.Modifier
          import androidx.navigation.NavController
          import com.kakdela.p2p.viewmodel.ChatViewModel

          @Composable
          fun ChatListScreen(viewModel: ChatViewModel, navController: NavController) {
              val chats by viewModel.chats.collectAsState(initial = emptyList())

              LazyColumn {
                  items(chats) { chat ->
                      ListItem(
                          headlineContent = { Text(chat.name) },
                          supportingContent = { Text(chat.lastMessage) },
                          modifier = Modifier.clickable { navController.navigate("chat/${chat.id}") }
                      )
                      Divider()
                  }
              }
          }
          EOF

          # ChatScreen.kt
          cat > app/src/main/java/com/kakdela/p2p/ui/ChatScreen.kt << 'EOF'
          package com.kakdela.p2p.ui

          import androidx.compose.foundation.lazy.LazyColumn
          import androidx.compose.foundation.lazy.items
          import androidx.compose.material3.*
          import androidx.compose.runtime.*
          import androidx.compose.ui.Modifier
          import androidx.navigation.NavController
          import com.kakdela.p2p.viewmodel.ChatViewModel

          @Composable
          fun ChatScreen(viewModel: ChatViewModel, chatId: Int, navController: NavController) {
              LaunchedEffect(chatId) { viewModel.loadMessages(chatId) }
              val messages by viewModel.messages.collectAsState(initial = emptyList())
              val text = remember { mutableStateOf("") }

              Column {
                  LazyColumn(Modifier.weight(1f)) {
                      items(messages) { message ->
                          Text(message.text)
                      }
                  }
                  TextField(value = text.value, onValueChange = { text.value = it })
                  Button(onClick = {
                      viewModel.sendMessage(chatId, text.value, true)
                      text.value = ""
                  }) { Text("Отправить") }
              }
          }
          EOF

      # Кэш Gradle
      - name: Кэш Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: \( {{ runner.os }}-gradle- \){{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      # Сборка
      - name: Сборка Debug APK
        run: |
          ./gradlew --version
          ./gradlew assembleDebug --stacktrace --info

      # Загрузка APK
      - name: Загрузка APK
        uses: actions/upload-artifact@v4
        with:
          name: kakdela-p2p-debug.apk
          path: app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: error
