name: Kakdela-p2p — AutoBuild (fixed AGP/pluginManagement)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # Ensure gradle wrapper 8.9 exists (download if missing)
      - name: Ensure Gradle wrapper 8.9
        run: |
          set -e
          if [ ! -f gradlew ]; then
            echo "No gradlew found — creating wrapper files for gradle 8.9"
            mkdir -p gradle/wrapper
            curl -sL https://raw.githubusercontent.com/gradle/gradle/v8.9.0/gradlew -o gradlew
            curl -sL https://raw.githubusercontent.com/gradle/gradle/v8.9.0/gradlew.bat -o gradlew.bat
            curl -sL https://raw.githubusercontent.com/gradle/gradle/v8.9.0/gradle/wrapper/gradle-wrapper.jar -o gradle/wrapper/gradle-wrapper.jar
            cat > gradle/wrapper/gradle-wrapper.properties <<'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.9-all.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF
            chmod +x gradlew
          else
            echo "gradlew present — will use existing wrapper"
          fi

      # Ensure local.properties points to Android SDK so Android plugin finds SDK
      - name: Create local.properties (so CI knows Android SDK path)
        run: |
          echo "sdk.dir=$ANDROID_HOME" > local.properties
          cat local.properties

      # Ensure gradle.properties contains AndroidX flags & some performance settings
      - name: Ensure gradle.properties (AndroidX + perf)
        run: |
          set -e
          if [ -f gradle.properties ]; then
            echo "gradle.properties exists, backing up"
            cp gradle.properties gradle.properties.bak
          fi
          # write/overwrite these safe defaults (will keep existing keys by appending if absent)
          grep -q '^android.useAndroidX=' gradle.properties || echo "android.useAndroidX=true" >> gradle.properties
          grep -q '^android.enableJetifier=' gradle.properties || echo "android.enableJetifier=true" >> gradle.properties
          grep -q '^org.gradle.jvmargs=' gradle.properties || echo "org.gradle.jvmargs=-Xmx4g -Dfile.encoding=UTF-8" >> gradle.properties
          grep -q '^org.gradle.caching=' gradle.properties || echo "org.gradle.caching=true" >> gradle.properties
          echo "---- gradle.properties ----"
          tail -n +1 gradle.properties

      # Ensure settings.gradle.kts (or settings.gradle) has pluginManagement.repositories including google()
      - name: Ensure pluginManagement repositories in settings file
        run: |
          set -e
          # prefer Kotlin settings file
          if [ -f settings.gradle.kts ]; then
            FILE=settings.gradle.kts
          elif [ -f settings.gradle ]; then
            FILE=settings.gradle
          else
            echo "No settings.gradle(.kts) found — creating settings.gradle.kts with pluginManagement and repos"
            cat > settings.gradle.kts <<'EOF'
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(org.gradle.api.initialization.dsl.RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}
rootProject.name = "Kakdela-p2p"
include(":app")
EOF
            FILE=settings.gradle.kts
          fi

          echo "Checking $FILE for pluginManagement..."
          if ! grep -q "pluginManagement" "$FILE" || ! grep -q "google()" "$FILE"; then
            echo "pluginManagement or google() missing — inserting safe pluginManagement header (backup original)"
            cp "$FILE" "$FILE.bak"
            cat > settings.gradle.kts <<'EOF'
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(org.gradle.api.initialization.dsl.RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}
rootProject.name = "Kakdela-p2p"
include(":app")
EOF
          else
            echo "pluginManagement with google() present"
          fi
          echo "---- settings.gradle(.kts) content ----"
          sed -n '1,160p' settings.gradle.kts || true

      # Optional safe patch: ensure root build.gradle(.kts) uses available AGP version (replace 8.5.2 -> 8.5.0 if present)
      - name: Fix known-bad AGP version (8.5.2 -> 8.5.0) and ensure Kotlin plugin version
        run: |
          set -e
          if [ -f build.gradle.kts ]; then
            echo "Patching build.gradle.kts if it contains 8.5.2"
            sed -i.bak 's/id("com.android.application") version "8\.5\.2"/id("com.android.application") version "8.5.0"/g' build.gradle.kts || true
            # ensure kotlin plugin not older than 1.9.22/1.9.25 — replace common patterns
            sed -i 's/id("org.jetbrains.kotlin.android") version "[0-9]\+\.[0-9]\+\.[0-9]\+"/id("org.jetbrains.kotlin.android") version "1.9.25"/g' build.gradle.kts || true
            echo "---- build.gradle.kts after patch ----"
            sed -n '1,160p' build.gradle.kts || true
          else
            echo "No root build.gradle.kts found — creating minimal root file with safe plugin versions"
            cat > build.gradle.kts <<'EOF'
plugins {
    id("com.android.application") version "8.5.0" apply false
    id("org.jetbrains.kotlin.android") version "1.9.25" apply false
}
EOF
          fi

      # Cache Gradle to speed up subsequent builds
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Finally run the build
      - name: Run Gradle assembleDebug
        run: |
          set -e
          ./gradlew --version
          # print a little info to logs
          echo "JAVA_HOME=$JAVA_HOME"
          echo "ANDROID_HOME=$ANDROID_HOME"
          # build debug APK
          ./gradlew assembleDebug --stacktrace --no-daemon --warning-mode=all

      - name: Upload APK artifact
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: kakdela-p2p-debug.apk
          path: app/build/outputs/apk/debug/app-debug.apk
          if-no-files-found: skip
