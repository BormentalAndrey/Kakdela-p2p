name: Unpack and Commit Project

# можно запустить вручную из Actions -> Run workflow
on:
  workflow_dispatch:

# даём действие право писать в содержимое репозитория
permissions:
  contents: write

jobs:
  unpack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (with auth)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Ensure unzip available
        run: sudo apt-get update && sudo apt-get install -y unzip

      - name: Ensure zip exists
        run: |
          ZIP="kakdela_p2p_full.zip"
          if [ ! -f "$ZIP" ]; then
            echo "ZIP file '$ZIP' not found in repo root. Place it and re-run workflow."
            ls -la
            exit 1
          fi
          echo "Found $ZIP"

      - name: Unzip archive into temp folder
        run: |
          ZIP="kakdela_p2p_full.zip"
          TMPDIR="tmp_unzip"
          rm -rf "$TMPDIR"
          mkdir -p "$TMPDIR"
          unzip -o "$ZIP" -d "$TMPDIR"
          echo "Unzipped to $TMPDIR"
          ls -la "$TMPDIR" | sed -n '1,40p'

      - name: Copy files to repository root (overwrite)
        run: |
          TMPDIR="tmp_unzip"
          # copy including dotfiles; overwrite existing
          shopt -s dotglob || true
          cp -r "$TMPDIR"/* ./
          # remove tmp
          rm -rf "$TMPDIR"
          echo "Copied files to repo root"

      - name: Optional: remove zip from repo root
        run: |
          # Uncomment to remove zip after unpack:
          # git rm -f kakdela_p2p_full.zip || true
          echo "ZIP remains in repo root. If you want to delete it automatically, uncomment git rm line."

      - name: Commit & push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Unpacked project from kakdela_p2p_full.zip (Action)" || echo "No changes to commit"
          # push using checkout credentials (GITHUB_TOKEN)
          git push origin HEAD:main || git push
